<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AED Map Thailand - Admin Auto-Approve Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Kanit', sans-serif; overflow: hidden; touch-action: manipulation; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        .admin-view { position: fixed; inset: 0; background: #f8fafc; z-index: 5000; display: none; overflow-y: auto; }
        .stat-card { background: white; border-radius: 1rem; padding: 1.25rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .aed-marker-approved { display: flex; justify-content: center; align-items: center; background-color: white; border: 2px solid #ef4444; border-radius: 50%; color: #ef4444; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .aed-marker-pending { display: flex; justify-content: center; align-items: center; background-color: #f3f4f6; border: 2px solid #9ca3af; border-radius: 50%; color: #9ca3af; }
        .user-pin { background-color: #3b82f6; border: 3px solid white; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        .custom-popup .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; }
        .custom-popup .leaflet-popup-content { margin: 0; width: 280px !important; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="fixed top-0 left-0 right-0 z-[1000] bg-white/90 backdrop-blur-sm shadow-md px-4 py-3 flex justify-between items-center rounded-b-2xl border-b border-gray-200">
        <div class="flex items-center gap-2">
            <img src="aed_logo.png" alt="Logo" class="w-10 h-10 rounded-full border bg-white object-contain">
            <div>
                <h1 class="font-bold text-gray-800 text-lg leading-none">AED Map</h1>
                <span id="status-badge" class="text-[10px] text-gray-400 font-medium bg-gray-100 px-1.5 py-0.5 rounded-full cursor-pointer">Connecting...</span>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button id="admin-entry-btn" onclick="toggleAdminView()" class="hidden bg-gray-800 text-white px-3 py-2 rounded-full text-sm font-bold shadow-lg active:scale-90 transition-all">
                <i class="fa-solid fa-chart-pie mr-1"></i> Dashboard
            </button>
            <a href="tel:1669" class="bg-red-600 text-white px-4 py-2 rounded-full font-bold shadow-lg animate-pulse text-sm">
                <i class="fa-solid fa-phone"></i> 1669
            </a>
        </div>
    </div>

    <div id="map"></div>

    <div class="fixed bottom-28 right-4 z-[999]">
        <button onclick="locateUser()" class="bg-white text-gray-700 w-12 h-12 rounded-full shadow-xl flex items-center justify-center border border-gray-100 active:scale-90 transition-all">
            <i class="fa-solid fa-crosshairs text-xl text-blue-500"></i>
        </button>
    </div>

    <div class="fixed bottom-8 left-0 right-0 z-[1000] flex justify-center pointer-events-none">
        <button onclick="toggleAddMode()" class="pointer-events-auto bg-gradient-to-r from-green-500 to-emerald-600 text-white px-8 py-4 rounded-full shadow-2xl font-bold flex items-center gap-2 active:scale-95 transition-all">
            <i class="fa-solid fa-plus text-lg"></i> ‡πÅ‡∏à‡πâ‡∏á‡∏à‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á AED
        </button>
    </div>

    <div id="admin-view" class="admin-view p-4 sm:p-8">
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• AED</h2>
                    <p class="text-sm text-gray-500">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î</p>
                </div>
                <button onclick="toggleAdminView()" class="bg-white border w-10 h-10 rounded-full shadow-sm hover:bg-gray-50 text-xl font-bold">√ó</button>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="stat-card">
                    <p class="text-[10px] text-gray-500 font-bold uppercase">‡∏à‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                    <p id="stat-total" class="text-3xl font-bold">0</p>
                </div>
                <div class="stat-card">
                    <p class="text-[10px] text-orange-500 font-bold uppercase">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
                    <p id="stat-pending" class="text-3xl font-bold text-orange-500">0</p>
                </div>
                <div class="stat-card">
                    <p class="text-[10px] text-green-500 font-bold uppercase">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</p>
                    <p id="stat-approved" class="text-3xl font-bold text-green-500">0</p>
                </div>
                <div class="stat-card">
                    <p class="text-[10px] text-blue-500 font-bold uppercase">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°</p>
                    <p id="stat-districts" class="text-3xl font-bold text-blue-500">0</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-sm border">
                    <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</h3>
                    <div id="area-stats-list" class="space-y-3 max-h-[400px] overflow-y-auto pr-2 text-sm"></div>
                </div>

                <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border overflow-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                        <button onclick="exportToCSV()" class="text-[10px] bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded-lg border border-emerald-200 hover:bg-emerald-100 transition-all font-bold">
                            <i class="fa-solid fa-file-excel mr-1"></i> Export Excel
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 text-[10px] uppercase text-gray-500">
                                <tr>
                                    <th class="p-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
                                    <th class="p-3">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</th>
                                    <th class="p-3">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th class="p-3 text-right">ACTION</th>
                                </tr>
                            </thead>
                            <tbody id="admin-table-body" class="text-[11px]"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="add-modal" class="hidden fixed inset-0 z-[2000] bg-black/60 flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl shadow-2xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î AED ‡πÉ‡∏´‡∏°‡πà</h2>
                <button onclick="closeModal()" class="text-gray-400 text-3xl">√ó</button>
            </div>
            <form id="aed-form" onsubmit="saveAED(event)">
                <div class="mb-4">
                    <button type="button" onclick="useCurrentLocationForAdd()" class="w-full bg-blue-600 text-white py-4 rounded-xl shadow-md mb-2 flex items-center justify-center gap-2 font-bold active:scale-95 transition-all">
                        <i class="fa-solid fa-location-crosshairs"></i> ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    </button>
                    <p id="gps-status" class="text-[10px] text-center text-gray-400 italic">‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏∑‡∏ô‡∏≠‡∏¢‡∏π‡πà</p>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô *</label>
                    <input type="text" id="location-name" required class="w-full px-4 py-3 border rounded-xl bg-gray-50 focus:ring-2 focus:ring-red-400 outline-none">
                </div>
                <div class="mb-5">
                    <label class="block text-gray-700 text-sm font-bold mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á *</label>
                    <textarea id="location-detail" required rows="2" class="w-full px-4 py-3 border rounded-xl bg-gray-50 focus:ring-2 focus:ring-red-400 outline-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏±‡πâ‡∏ô 1 ‡πÇ‡∏ã‡∏ô‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå"></textarea>
                </div>
                <input type="hidden" id="lat-input"><input type="hidden" id="lng-input">
                <button type="submit" id="save-btn" class="w-full bg-red-500 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-red-600 transition-colors">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, updateDoc, doc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDp0HC7Wh2fH13XbMXrzvrFSQpB3q0breI",
            authDomain: "aed-map-th-488a6.firebaseapp.com",
            projectId: "aed-map-th-488a6",
            storageBucket: "aed-map-th-488a6.firebasestorage.app",
            messagingSenderId: "264816215714",
            appId: "1:264816215714:web:92494e9281eed1f7e5f9fb"
        };
        
        const ADMIN_UID = "92k0JYOorjZu48FaAMDgPvFPr0i2";
        const appId = 'aed-map-th-488a6';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let map, userMarker, tempMarker, currentUser = null, isAddMode = false, markersLayer = L.layerGroup(), allData = [];

        Object.assign(window, { toggleAdminView, toggleAddMode, closeModal, saveAED, approveAED, deleteAED, loginWithGoogle, logout, useCurrentLocationForAdd, exportToCSV, locateUser });

        window.onload = () => { initMap(); initAuth(); };

        function initMap() {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([13.7649, 100.5383], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            markersLayer.addTo(map);
            map.on('click', (e) => {
                if(!isAddMode) return;
                document.getElementById('lat-input').value = e.latlng.lat;
                document.getElementById('lng-input').value = e.latlng.lng;
                document.getElementById('add-modal').classList.remove('hidden');
                if(tempMarker) map.removeLayer(tempMarker);
                tempMarker = L.marker(e.latlng).addTo(map);
            });
            locateUser();
        }

        async function initAuth() {
            onAuthStateChanged(auth, (user) => {
                const badge = document.getElementById('status-badge');
                currentUser = user;
                if (user) {
                    const isAdmin = user.uid === ADMIN_UID;
                    badge.innerHTML = isAdmin ? '<i class="fa-solid fa-user-shield"></i> Admin: Online' : `<i class="fa-solid fa-user"></i> ${user.displayName.split(' ')[0]}`;
                    badge.onclick = logout;
                    if(isAdmin) document.getElementById('admin-entry-btn').classList.remove('hidden');
                } else {
                    badge.innerHTML = '<i class="fa-solid fa-lock"></i> ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠ Login';
                    badge.onclick = loginWithGoogle;
                }
                setupDataListener();
            });
        }

        async function loginWithGoogle() { await signInWithPopup(auth, new GoogleAuthProvider()); }
        async function logout() { if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?")) await signOut(auth); window.location.reload(); }

        function setupDataListener() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'aed_locations'));
            onSnapshot(q, (snapshot) => {
                allData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMarkers(allData);
                if(currentUser && currentUser.uid === ADMIN_UID) updateAdminDashboard(allData);
            });
        }

        function renderMarkers(data) {
            markersLayer.clearLayers();
            const isAdmin = currentUser && currentUser.uid === ADMIN_UID;
            data.forEach(p => {
                if(!isAdmin && p.status !== 'approved') return;
                const isPending = p.status === 'pending';
                const marker = L.marker([p.lat, p.lng], {
                    icon: L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div class='w-10 h-10 ${isPending ? "aed-marker-pending" : "aed-marker-approved"}'><i class='fa-solid fa-heart-pulse'></i></div>`,
                        iconSize: [40, 40], iconAnchor: [20, 20], popupAnchor: [0, -25]
                    })
                });

                let popupHtml = `
                    <div class="p-1 font-kanit">
                        <h3 class="font-bold text-gray-800">${p.name} ${isPending ? '<span class="text-orange-500 text-xs">(‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)</span>' : ''}</h3>
                        <p class="text-[11px] text-gray-500 mb-2">${p.detail}</p>
                        <a href="http://googleusercontent.com/maps.google.com/4{p.lat},${p.lng}" target="_blank" class="block w-full bg-blue-600 text-white text-center py-2 rounded-lg text-[10px] font-bold mb-1">‡∏ô‡∏≥‡∏ó‡∏≤‡∏á (Google Maps)</a>`;
                
                if (isAdmin && isPending) {
                    popupHtml += `<button onclick="approveAED('${p.id}')" class="w-full bg-green-500 text-white py-2 rounded-lg text-[10px] font-bold mb-1"><i class="fa-solid fa-check mr-1"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ</button>`;
                }
                if (isAdmin) {
                    popupHtml += `<button onclick="deleteAED('${p.id}')" class="w-full bg-red-100 text-red-600 py-1.5 rounded-lg text-[9px] font-bold">‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ</button>`;
                }

                popupHtml += `</div>`;
                marker.bindPopup(popupHtml, { className: 'custom-popup' });
                markersLayer.addLayer(marker);
            });
        }

        function locateUser() {
            navigator.geolocation.getCurrentPosition((pos) => {
                const { latitude, longitude } = pos.coords;
                map.setView([latitude, longitude], 17);
                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.marker([latitude, longitude], { 
                    icon: L.divIcon({ className: 'user-pin', iconSize: [20, 20], iconAnchor: [10, 10] }) 
                }).addTo(map);
            }, null, { enableHighAccuracy: true });
        }

        async function useCurrentLocationForAdd() {
            const statusText = document.getElementById('gps-status');
            statusText.innerText = "üìç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS...";
            navigator.geolocation.getCurrentPosition((pos) => {
                const { latitude, longitude } = pos.coords;
                document.getElementById('lat-input').value = latitude;
                document.getElementById('lng-input').value = longitude;
                map.setView([latitude, longitude], 18);
                if (tempMarker) map.removeLayer(tempMarker);
                tempMarker = L.marker([latitude, longitude]).addTo(map);
                statusText.innerText = "‚úÖ ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
                statusText.className = "text-[10px] text-green-600 font-bold";
            }, () => alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS"), { enableHighAccuracy: true });
        }

        async function saveAED(e) {
            e.preventDefault();
            const btn = document.getElementById('save-btn');
            const lat = parseFloat(document.getElementById('lat-input').value);
            const lng = parseFloat(document.getElementById('lng-input').value);

            if(!lat || !lng) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");

            btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà...";
            
            // --- ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Auto-approve ---
            const isAdmin = currentUser && currentUser.uid === ADMIN_UID;
            const targetStatus = isAdmin ? 'approved' : 'pending';

            let district = "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏", province = "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=th`);
                const json = await res.json();
                district = json.address.amphoe || json.address.district || district;
                province = json.address.province || province;
            } catch(e) { console.warn("Reverse Geocoding failed"); }

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'aed_locations'), {
                    name: document.getElementById('location-name').value,
                    detail: document.getElementById('location-detail').value,
                    lat, lng, district, province,
                    status: targetStatus, // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
                    createdBy: currentUser.uid,
                    creatorName: currentUser.displayName,
                    timestamp: serverTimestamp()
                });
                alert(isAdmin ? "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!" : "‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏±‡∏ö");
                closeModal();
            } catch(err) { alert(err.message); }
            btn.disabled = false; btn.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
        }

        function updateAdminDashboard(data) {
            const stats = data.reduce((acc, curr) => {
                acc.total++;
                acc[curr.status === 'approved' ? 'approved' : 'pending']++;
                const areaKey = `${curr.province || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} - ${curr.district || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}`;
                acc.areas[areaKey] = (acc.areas[areaKey] || 0) + 1;
                return acc;
            }, { total: 0, pending: 0, approved: 0, areas: {} });

            document.getElementById('stat-total').innerText = stats.total;
            document.getElementById('stat-pending').innerText = stats.pending;
            document.getElementById('stat-approved').innerText = stats.approved;
            document.getElementById('stat-districts').innerText = Object.keys(stats.areas).length;

            let areaHtml = "";
            Object.entries(stats.areas).sort((a,b) => b[1] - a[1]).forEach(([name, count]) => {
                areaHtml += `<div class="flex justify-between items-center text-xs border-b pb-2"><span>${name}</span><span class="font-bold text-red-600 bg-red-50 px-2 py-0.5 rounded-full">${count}</span></div>`;
            });
            document.getElementById('area-stats-list').innerHTML = areaHtml;

            let tableHtml = "";
            data.forEach(p => {
                tableHtml += `
                    <tr class="border-b hover:bg-gray-50 transition-colors">
                        <td class="p-3"><p class="font-bold text-gray-800">${p.name}</p><p class="text-[9px] text-gray-400">${p.creatorName || 'Anonymous'}</p></td>
                        <td class="p-3 text-[10px]">${p.district}<br><span class="text-gray-400">${p.province}</span></td>
                        <td class="p-3"><span class="px-2 py-0.5 rounded-full text-[9px] font-bold ${p.status === 'approved' ? 'bg-green-100 text-green-600' : 'bg-orange-100 text-orange-600'}">${p.status.toUpperCase()}</span></td>
                        <td class="p-3 text-right">
                            <div class="flex justify-end gap-3">
                                ${p.status === 'pending' ? `<button onclick="approveAED('${p.id}')" class="text-green-500 hover:scale-125 transition-all"><i class="fa-solid fa-circle-check text-lg"></i></button>` : `<i class="fa-solid fa-circle-check text-gray-200 text-lg"></i>`}
                                <button onclick="deleteAED('${p.id}')" class="text-red-300 hover:text-red-600 transition-all"><i class="fa-solid fa-trash-can text-lg"></i></button>
                            </div>
                        </td>
                    </tr>`;
            });
            document.getElementById('admin-table-body').innerHTML = tableHtml;
        }

        async function approveAED(id) { if(confirm("‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏™‡∏π‡πà‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞?")) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'aed_locations', id), { status: 'approved' }); }
        async function deleteAED(id) { if(confirm("‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'aed_locations', id)); }

        function toggleAdminView() {
            const panel = document.getElementById('admin-view');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

        function toggleAddMode() { if(!currentUser) { loginWithGoogle(); return; } isAddMode = true; alert("‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏Ñ‡∏£‡∏±‡∏ö"); }
        function closeModal() { document.getElementById('add-modal').classList.add('hidden'); isAddMode = false; if(tempMarker) map.removeLayer(tempMarker); }

        function exportToCSV() {
            let csv = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà,‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î,‡∏≠‡∏≥‡πÄ‡∏†‡∏≠,‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î,‡∏û‡∏¥‡∏Å‡∏±‡∏î(Lat),‡∏û‡∏¥‡∏Å‡∏±‡∏î(Lng),‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á,‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞\n";
            allData.forEach(p => { csv += `"${p.name}","${p.detail}","${p.district}","${p.province}",${p.lat},${p.lng},"${p.creatorName}","${p.status}"\n`; });
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Report_AED_Map_${new Date().toLocaleDateString('th-TH')}.csv`;
            link.click();
        }
    </script>
</body>
</html>
